<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ê¸‰ì‹ ê³µì§€</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --accent: #4a90e2;
            --border: #ddd;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --accent: #64b5f6;
            --border: #444;
        }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: var(--text-color); font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content { padding: 20px; max-width: 800px; margin: 0 auto; display: none; }
        .content.active { display: block; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .meal-title { color: var(--accent); font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        .meal-menu { font-size: 1.1em; white-space: pre-line; line-height: 1.5; }

        /* í‘œ ìŠ¤íƒ€ì¼ */
        .menu-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .menu-table th, .menu-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
        .menu-table th { background: var(--accent); color: white; }

        /* ê´€ë¦¬ì & í† ê¸€ */
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        textarea { width: 100%; height: 150px; margin-bottom: 10px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border); }
        button.action-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; }
        
        .loading { text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('next-meal')">ë‹¤ìŒ ì‹ì‚¬</button>
    <button class="tab-btn" onclick="switchTab('weekly')">ì£¼ê°„ ë©”ë‰´</button>
    <button class="tab-btn" onclick="switchTab('upload')">ë©”ë‰´ ì—…ë¡œë“œ</button>
</div>

<div id="next-meal" class="content active">
    <div id="next-meal-container">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<div id="weekly" class="content">
    <div style="overflow-x: auto;">
        <table class="menu-table" id="weekly-table">
            </table>
    </div>
</div>

<div id="upload" class="content">
    <div id="login-form">
        <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="padding:10px; width:80%; margin-bottom:10px;">
        <button class="action-btn" onclick="checkLogin()">ë¡œê·¸ì¸</button>
    </div>
    <div id="upload-form" style="display:none;">
        <h3>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h3>
        <p style="font-size:0.8em; color:gray;">ì—‘ì…€ì—ì„œ 5í–‰ 8ì—´(ê³µë€+ë‚ ì§œ í¬í•¨) ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
        <textarea id="paste-area" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°..."></textarea>
        <button class="action-btn" onclick="uploadMenu()">ì—…ë¡œë“œ í•˜ê¸°</button>
    </div>
</div>

<button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>

<script>
    // â–¼â–¼â–¼ ì—¬ê¸°ì— ë°°í¬í•œ ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3XJo_EgPpaVKzIXKKm09jIt4MBTtr2DDN5touBGFbdwbKPbP63B7nHvA87mChWT0CGg/exec';
    
    let globalMenuData = null; // [5][8] ë°°ì—´

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        applyTheme();
    });

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchData() {
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                globalMenuData = data.menu;
                if(globalMenuData.length > 0) {
                    renderNextMeal();
                    renderWeeklyTable();
                } else {
                    document.getElementById('next-meal-container').innerHTML = '<div class="card">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(err => alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err));
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // [íƒ­ 1] ë‹¤ìŒ ì‹ì‚¬ ë¡œì§
    function renderNextMeal() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentDay = now.getDay(); // 0(ì¼)~6(í† )
        
        // ë°ì´í„° êµ¬ì¡°: Col 0=ë¼ë²¨, 1=í† , 2=ì¼, 3=ì›”, 4=í™”, 5=ìˆ˜, 6=ëª©, 7=ê¸ˆ
        // JS getDay(): 6=í† , 0=ì¼, 1=ì›”...
        // ë§¤í•‘: í† (6)->idx 1, ì¼(0)->idx 2, ì›”(1)->idx 3 ... ê¸ˆ(5)->idx 7
        let dayIdx = currentDay === 6 ? 1 : currentDay + 2;
        if (dayIdx > 7) dayIdx = 2; // ì¼ìš”ì¼ ë³´ì •

        // ì‹ì‚¬ ì¸ë±ìŠ¤: 2=ì¡°ì‹, 3=ì¤‘ì‹, 4=ì„ì‹
        let currentMealType = -1; // 0:ì¡°ì‹ì „, 1:ì¡°ì‹ì¤‘, 2:ì¤‘ì‹ì „, 3:ì¤‘ì‹ì¤‘, 4:ì„ì‹ì „, 5:ì„ì‹ì¤‘, 6:ì„ì‹í›„

        // ì‹œê°„ ë¡œì§ (ì¡°ì‹ 05-06, ì¤‘ì‹ 12-13, ì„ì‹ 18-20)
        if (currentHour < 5) currentMealType = 0; // ì¡°ì‹ ì „
        else if (currentHour < 6) currentMealType = 1; // ì¡°ì‹ ì¤‘
        else if (currentHour < 12) currentMealType = 2; // ì¤‘ì‹ ì „
        else if (currentHour < 13) currentMealType = 3; // ì¤‘ì‹ ì¤‘
        else if (currentHour < 18) currentMealType = 4; // ì„ì‹ ì „
        else if (currentHour < 20) currentMealType = 5; // ì„ì‹ ì¤‘
        else currentMealType = 6; // ì„ì‹ í›„ (ë‚´ì¼ ì¡°ì‹)

        const container = document.getElementById('next-meal-container');
        container.innerHTML = '';

        // í‘œì‹œí•  ì‹ì‚¬ ìˆœì„œ ê³„ì‚° í•¨ìˆ˜
        function getMealInfo(dIdx, typeRow) {
            // ë‚ ì§œ/ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
            const dateStr = globalMenuData[0][dIdx] + " (" + globalMenuData[1][dIdx] + ")";
            const typeStr = globalMenuData[typeRow][0]; // ì¡°/ì¤‘/ì„ í…ìŠ¤íŠ¸
            const menuStr = globalMenuData[typeRow][dIdx];
            return { date: dateStr, type: typeStr, menu: menuStr };
        }

        let mealsToShow = [];

        // ë¡œì§: í˜„ì¬ ì‹œê°„ì— ë”°ë¼ "ì´ë²ˆ ì‹ì‚¬"ì™€ "ë‹¤ìŒ ì‹ì‚¬" ê²°ì •
        // typeRow: 2=ì¡°ì‹, 3=ì¤‘ì‹, 4=ì„ì‹
        
        if (currentMealType <= 1) { // ì¡°ì‹ íƒ€ì„ or ì „
            mealsToShow.push(getMealInfo(dayIdx, 2)); // ì˜¤ëŠ˜ ì¡°ì‹
            mealsToShow.push(getMealInfo(dayIdx, 3)); // ì˜¤ëŠ˜ ì¤‘ì‹
        } else if (currentMealType <= 3) { // ì¤‘ì‹ íƒ€ì„ or ì „
            mealsToShow.push(getMealInfo(dayIdx, 3)); // ì˜¤ëŠ˜ ì¤‘ì‹
            mealsToShow.push(getMealInfo(dayIdx, 4)); // ì˜¤ëŠ˜ ì„ì‹
        } else if (currentMealType <= 5) { // ì„ì‹ íƒ€ì„ or ì „
            mealsToShow.push(getMealInfo(dayIdx, 4)); // ì˜¤ëŠ˜ ì„ì‹
            // ë‚´ì¼ ì¡°ì‹ (í† ìš”ì¼->ì¼ìš”ì¼, ê¸ˆìš”ì¼->ë‹¤ìŒì£¼ í† ìš”ì¼?? ì¼ë‹¨ ìˆœí™˜ ë¡œì§ì€ ë³µì¡í•˜ë‹ˆ ê¸ˆìš”ì¼ì´ë©´ ëìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë‹¤ìŒ ì¸ë±ìŠ¤)
            let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) mealsToShow.push(getMealInfo(nextDayIdx, 2));
            else mealsToShow.push({date: "ë‹¤ìŒ ì£¼", type: "ì¡°ì‹", menu: "ì—…ë¡œë“œ ëŒ€ê¸°ì¤‘"}); 
        } else { // ì„ì‹ ì´í›„
             let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) {
                mealsToShow.push(getMealInfo(nextDayIdx, 2)); // ë‚´ì¼ ì¡°ì‹
                mealsToShow.push(getMealInfo(nextDayIdx, 3)); // ë‚´ì¼ ì¤‘ì‹
            } else {
                 mealsToShow.push({date: "ë‹¤ìŒ ì£¼", type: "ì¡°ì‹", menu: "ì‹ë‹¨í‘œ ì—…ë°ì´íŠ¸ í•„ìš”"});
            }
        }

        // ë Œë”ë§
        mealsToShow.forEach((m, i) => {
            const label = i === 0 ? (currentHour >= 5 && currentHour < 20 && ![2,4,6].includes(currentMealType) ? "ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬" : "ê³§ ë‹¤ê°€ì˜¤ëŠ” ì‹ì‚¬") : "ê·¸ ë‹¤ìŒ ì‹ì‚¬";
            container.innerHTML += `
                <div class="card">
                    <div class="meal-title">${label} - ${m.date} ${m.type}</div>
                    <div class="meal-menu">${m.menu || '-'}</div>
                </div>
            `;
        });
    }

    // [íƒ­ 2] ì£¼ê°„ ë©”ë‰´ í…Œì´ë¸” ë Œë”ë§
    function renderWeeklyTable() {
        const table = document.getElementById('weekly-table');
        let html = '';
        globalMenuData.forEach(row => {
            html += '<tr>';
            row.forEach((cell, i) => {
                const tag = (i === 0 || row === globalMenuData[0] || row === globalMenuData[1]) ? 'th' : 'td';
                html += `<${tag}>${cell}</${tag}>`;
            });
            html += '</tr>';
        });
        table.innerHTML = html;
    }

    // [íƒ­ 3] ê´€ë¦¬ì ê¸°ëŠ¥
    function checkLogin() {
        const pw = document.getElementById('admin-pw').value;
        if(pw === 'fgip.admin') {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('upload-form').style.display = 'block';
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    function uploadMenu() {
        const raw = document.getElementById('paste-area').value;
        if(!raw) return;

        // ì—‘ì…€ ë¶™ì—¬ë„£ê¸° íŒŒì‹± (íƒ­ ë¬¸ìë¡œ ë¶„ë¦¬)
        const rows = raw.trim().split('\n').map(r => r.split('\t'));
        
        // ë°ì´í„° ì •ì œ (ë¹ˆ ì…€ ì²˜ë¦¬ ë“±)
        if(rows.length !== 5) {
            alert('í–‰ ê°œìˆ˜ê°€ 5ê°œê°€ ì•„ë‹™ë‹ˆë‹¤. ë¹ˆ ì¤„ì´ë‚˜ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        if(!confirm('ê¸°ì¡´ ë©”ë‰´ ìœ„ì— ìƒˆë¡œìš´ ë©”ë‰´ë¥¼ ì—…ë°ì´íŠ¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(rows)
        })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                alert('ì—…ë¡œë“œ ì„±ê³µ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + data.message);
            }
        })
        .catch(err => alert('ì—…ë¡œë“œ í†µì‹  ì˜¤ë¥˜: ' + err));
    }

    // [ê³µí†µ] ë‹¤í¬ëª¨ë“œ
    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function applyTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) document.body.setAttribute('data-theme', saved);
    }
</script>
</body>

</html>
