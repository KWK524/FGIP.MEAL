<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ê¸‰ì‹ ê³µì§€</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --accent: #4a90e2;
            --border: #ddd;
            --input-bg: #fff;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --accent: #64b5f6;
            --border: #444;
            --input-bg: #333;
        }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; padding-bottom: 50px; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: var(--text-color); font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content { padding: 20px; max-width: 900px; margin: 0 auto; display: none; }
        .content.active { display: block; }

        /* ì¹´ë“œ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .meal-title { color: var(--accent); font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        .meal-menu { font-size: 1.1em; white-space: pre-wrap; line-height: 1.6; }

        .menu-table { width: 100%; border-collapse: collapse; font-size: 0.85em; table-layout: fixed; }
        .menu-table th, .menu-table td { border: 1px solid var(--border); padding: 8px; text-align: center; vertical-align: middle; white-space: pre-wrap; }
        .menu-table th { background: var(--accent); color: white; width: 60px; }

        /* ì…ë ¥ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .input-grid { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .input-grid th, .input-grid td { border: 1px solid var(--border); padding: 0; margin: 0; }
        .input-grid th { background: #eee; color: #333; padding: 10px; font-size: 0.9em; width: 60px; text-align: center; }
        
        .cell-input { 
            width: 100%; height: 100%; border: none; outline: none; 
            padding: 8px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color);
            font-family: inherit; resize: none; display: block;
        }
        .cell-input:focus { background: rgba(74, 144, 226, 0.1); }
        textarea.cell-input { min-height: 80px; white-space: pre-wrap; }
        input.cell-input { text-align: center; }

        /* ìŠ¤ë§ˆíŠ¸ ë„êµ¬ ì„¹ì…˜ */
        .smart-tools { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 20px; }
        .tool-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .smart-paste-area { width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 0.8em; background: var(--input-bg); color: var(--text-color); }
        
        button.action-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin-top: 10px; }
        button.small-btn { padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('next-meal')">ë‹¤ìŒ ì‹ì‚¬</button>
    <button class="tab-btn" onclick="switchTab('weekly')">ì£¼ê°„ ë©”ë‰´</button>
    <button class="tab-btn" onclick="switchTab('upload')">ë©”ë‰´ ì—…ë¡œë“œ</button>
</div>

<div id="next-meal" class="content active">
    <div id="next-meal-container"><div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
</div>

<div id="weekly" class="content">
    <div style="overflow-x: auto;">
        <table class="menu-table" id="weekly-table"></table>
    </div>
</div>

<div id="upload" class="content">
    <div id="login-form">
        <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="padding:10px; width:80%; margin-bottom:10px;">
        <button class="action-btn" onclick="checkLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="upload-form" style="display:none;">
        <h3>ì£¼ê°„ ë©”ë‰´ ì‘ì„±</h3>

        <div class="smart-tools">
            <div class="tool-row">
                <label><strong>1. ì‹œì‘ì¼ ì„¤ì • (í† ìš”ì¼):</strong></label>
                <input type="date" id="start-date-picker">
                <button class="small-btn" onclick="autoFillDates()">ë‚ ì§œ ìë™ ì±„ìš°ê¸°</button>
            </div>
            <p style="font-size:0.8em; color:gray; margin:0;">* ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì¼ì£¼ì¼ì¹˜ ë‚ ì§œê°€ ê³„ì‚°ë˜ì–´ í‘œì— ì…ë ¥ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="smart-tools">
            <label><strong>2. ì‹ë‹¨ í•œ ë²ˆì— ë„£ê¸° (ì—‘ì…€ ë¶™ì—¬ë„£ê¸°):</strong></label>
            <textarea id="smart-paste-area" class="smart-paste-area" placeholder="ì—‘ì…€ì—ì„œ [ì¡°ì‹/ì¤‘ì‹/ì„ì‹] x [7ì¼] ë°ì´í„°(3í–‰ 7ì—´)ë§Œ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê³  ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”."></textarea>
            <button class="small-btn" onclick="applySmartPaste()">í‘œì— ì ìš©í•˜ê¸°</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="input-grid" id="edit-table">
                <tr id="row-date">
                    <th>ë‚ ì§œ</th>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input date-cell" placeholder="00ì›”00ì¼"></td>
                </tr>
                <tr>
                    <th>ìš”ì¼</th>
                    <td><input class="cell-input" value="í† " readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="ì¼" readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="ì›”" readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="í™”" readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="ìˆ˜" readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="ëª©" readonly style="background:#f9f9f9; text-align:center;"></td>
                    <td><input class="cell-input" value="ê¸ˆ" readonly style="background:#f9f9f9; text-align:center;"></td>
                </tr>
                <tr id="row-bf">
                    <th>ì¡°ì‹</th>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                </tr>
                <tr id="row-lh">
                    <th>ì¤‘ì‹</th>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                </tr>
                <tr id="row-dn">
                    <th>ì„ì‹</th>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                    <td><textarea class="cell-input meal-cell"></textarea></td>
                </tr>
            </table>
        </div>

        <button class="action-btn" onclick="uploadMenuFromGrid()">ì„œë²„ì— ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>

<script>
    // â–¼â–¼â–¼ ë³¸ì¸ì˜ ì›¹ ì•± URL ì…ë ¥ â–¼â–¼â–¼
    const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; 

    let globalMenuData = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        applyTheme();
    });

    function fetchData() {
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                globalMenuData = data.menu;
                if(globalMenuData && globalMenuData.length > 0) {
                    renderNextMeal();
                    renderWeeklyTable();
                } else {
                    document.getElementById('next-meal-container').innerHTML = '<div class="card">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(err => {
                document.getElementById('next-meal-container').innerHTML = '<div class="card">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”)</div>';
            });
    }

    function switchTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // [ê¸°ëŠ¥ 1] ë‚ ì§œ ìë™ ê³„ì‚°
    function autoFillDates() {
        const picker = document.getElementById('start-date-picker');
        if(!picker.value) {
            alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const dateCells = document.querySelectorAll('.date-cell');
        let currentDate = new Date(picker.value);

        // ìš”ì¼ ì²´í¬ (í† ìš”ì¼ì¸ì§€)
        if(currentDate.getDay() !== 6) {
            if(!confirm('ì„ íƒí•œ ë‚ ì§œê°€ í† ìš”ì¼ì´ ì•„ë‹™ë‹ˆë‹¤. ê·¸ë˜ë„ ì§„í–‰í• ê¹Œìš”?')) return;
        }

        // 7ì¼ì¹˜ ë£¨í”„ (ìë°”ìŠ¤í¬ë¦½íŠ¸ Date ê°ì²´ëŠ” ìë™ìœ¼ë¡œ ì›”/ë…„ ë„˜ì–´ê° ì²˜ë¦¬)
        dateCells.forEach(cell => {
            const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            const day = currentDate.getDate().toString().padStart(2, '0');
            cell.value = `${month}ì›”${day}ì¼`;
            
            // í•˜ë£¨ ì¦ê°€
            currentDate.setDate(currentDate.getDate() + 1);
        });
    }

    // [ê¸°ëŠ¥ 2] ìŠ¤ë§ˆíŠ¸ ë¶™ì—¬ë„£ê¸° (íŒŒì‹± ë¡œì§)
    function applySmartPaste() {
        const rawText = document.getElementById('smart-paste-area').value;
        if(!rawText.trim()) {
            alert('ë¶™ì—¬ë„£ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì¤„ë°”ê¿ˆìœ¼ë¡œ í–‰ ë¶„ë¦¬
        const rows = rawText.trim().split('\n');
        
        // ì…ë ¥ ëŒ€ìƒ í–‰ë“¤ (ì¡°ì‹, ì¤‘ì‹, ì„ì‹)
        const targetRowIds = ['row-bf', 'row-lh', 'row-dn'];

        // ì—‘ì…€ì—ì„œ ë³µì‚¬í•˜ë©´ íƒ­(\t)ìœ¼ë¡œ ì—´ì´ êµ¬ë¶„ë¨
        let rowCount = 0;
        rows.forEach((rowStr) => {
            if(rowCount >= 3) return; // 3ë¼ë‹ˆë§Œ ì²˜ë¦¬

            const cols = rowStr.split('\t');
            // í•´ë‹¹ í–‰ì˜ ì…ë ¥ì¹¸ë“¤ ì°¾ê¸°
            const targetRow = document.getElementById(targetRowIds[rowCount]);
            const inputs = targetRow.querySelectorAll('textarea');

            // ê° ì¹¸ì— ê°’ ë„£ê¸° (ìµœëŒ€ 7ê°œ)
            cols.forEach((val, idx) => {
                if(idx < 7 && inputs[idx]) {
                    // ë”°ì˜´í‘œ ì œê±° ë“± ê¹”ë”í•˜ê²Œ ì •ë¦¬
                    let cleanVal = val.replace(/^"|"$/g, '').trim(); 
                    inputs[idx].value = cleanVal;
                }
            });
            rowCount++;
        });

        alert('í‘œì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”.');
    }

    // ê¸°ì¡´ ë¡œì§ë“¤ (ë Œë”ë§, ì—…ë¡œë“œ ë“±)
    function renderNextMeal() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentDay = now.getDay(); 
        
        let dayIdx = currentDay === 6 ? 1 : currentDay + 2;
        if (dayIdx > 7) dayIdx = 2; 

        let currentMealType = -1; 
        if (currentHour < 5) currentMealType = 0; 
        else if (currentHour < 6) currentMealType = 1; 
        else if (currentHour < 12) currentMealType = 2; 
        else if (currentHour < 13) currentMealType = 3; 
        else if (currentHour < 18) currentMealType = 4; 
        else if (currentHour < 20) currentMealType = 5; 
        else currentMealType = 6; 

        const container = document.getElementById('next-meal-container');
        container.innerHTML = '';

        function getMealInfo(dIdx, typeRow) {
            const dateStr = globalMenuData[0][dIdx] + " (" + globalMenuData[1][dIdx] + ")";
            const typeStr = globalMenuData[typeRow][0];
            const menuStr = globalMenuData[typeRow][dIdx];
            return { date: dateStr, type: typeStr, menu: menuStr };
        }

        let mealsToShow = [];
        if (currentMealType <= 1) { 
            mealsToShow.push(getMealInfo(dayIdx, 2)); 
            mealsToShow.push(getMealInfo(dayIdx, 3)); 
        } else if (currentMealType <= 3) { 
            mealsToShow.push(getMealInfo(dayIdx, 3)); 
            mealsToShow.push(getMealInfo(dayIdx, 4)); 
        } else if (currentMealType <= 5) { 
            mealsToShow.push(getMealInfo(dayIdx, 4)); 
            let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) mealsToShow.push(getMealInfo(nextDayIdx, 2));
        } else { 
             let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) {
                mealsToShow.push(getMealInfo(nextDayIdx, 2)); 
                mealsToShow.push(getMealInfo(nextDayIdx, 3)); 
            } else {
                 mealsToShow.push({date: "ë‹¤ìŒ ì£¼", type: "ì¡°ì‹", menu: "ì‹ë‹¨í‘œ ì—…ë°ì´íŠ¸ í•„ìš”"});
            }
        }

        mealsToShow.forEach((m, i) => {
            const label = i === 0 ? "ê³§ ë‹¤ê°€ì˜¤ëŠ” ì‹ì‚¬" : "ê·¸ ë‹¤ìŒ ì‹ì‚¬";
            container.innerHTML += `
                <div class="card">
                    <div class="meal-title">${label} - ${m.date} ${m.type}</div>
                    <div class="meal-menu">${m.menu || '-'}</div>
                </div>
            `;
        });
    }

    function renderWeeklyTable() {
        const table = document.getElementById('weekly-table');
        let html = '';
        globalMenuData.forEach((row, rIdx) => {
            html += '<tr>';
            row.forEach((cell, cIdx) => {
                const tag = (cIdx === 0 || rIdx === 0 || rIdx === 1) ? 'th' : 'td';
                html += `<${tag}>${cell}</${tag}>`;
            });
            html += '</tr>';
        });
        table.innerHTML = html;
    }

    function checkLogin() {
        const pw = document.getElementById('admin-pw').value;
        if(pw === 'fgip.admin') {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('upload-form').style.display = 'block';
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    function uploadMenuFromGrid() {
        const table = document.getElementById('edit-table');
        const rows = table.querySelectorAll('tr');
        let data = [];

        // í—¤ë” í…ìŠ¤íŠ¸
        const rowHeaders = ["(ê³µë€)", "(ê³µë€)", "ì¡°ì‹", "ì¤‘ì‹", "ì„ì‹"];

        rows.forEach((tr, rIdx) => {
            let rowData = [];
            rowData.push(rowHeaders[rIdx]);
            const inputs = tr.querySelectorAll('.cell-input');
            inputs.forEach(input => {
                rowData.push(input.value);
            });
            data.push(rowData);
        });

        if(!confirm('ì´ëŒ€ë¡œ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(resData => {
            if(resData.result === 'success') {
                alert('ì €ì¥ ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + resData.message);
            }
        })
        .catch(err => alert('í†µì‹  ì˜¤ë¥˜: ' + err));
    }

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function applyTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) document.body.setAttribute('data-theme', saved);
    }
</script>
</body>
</html>
