<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ê¸‰ì‹ ê³µì§€</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --accent: #4a90e2;
            --border: #ddd;
            --input-bg: #fff;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --accent: #64b5f6;
            --border: #444;
            --input-bg: #333;
        }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; padding-bottom: 50px; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: var(--text-color); font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content { padding: 20px; max-width: 900px; margin: 0 auto; display: none; }
        .content.active { display: block; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .meal-title { color: var(--accent); font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        .meal-menu { font-size: 1.1em; white-space: pre-wrap; line-height: 1.6; }

        /* ì¡°íšŒìš© í‘œ ìŠ¤íƒ€ì¼ */
        .menu-table { width: 100%; border-collapse: collapse; font-size: 0.85em; table-layout: fixed; }
        .menu-table th, .menu-table td { border: 1px solid var(--border); padding: 8px; text-align: center; vertical-align: middle; white-space: pre-wrap; }
        .menu-table th { background: var(--accent); color: white; width: 80px; }
        .menu-table td { min-width: 100px; }

        /* ì…ë ¥ìš© ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ (NEW) */
        .input-grid { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .input-grid th, .input-grid td { border: 1px solid var(--border); padding: 0; margin: 0; }
        .input-grid th { background: #eee; color: #333; padding: 10px; font-size: 0.9em; width: 60px; }
        
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .cell-input { 
            width: 100%; height: 100%; min-height: 40px; border: none; outline: none; 
            padding: 8px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color);
            font-family: inherit; resize: vertical; display: block;
        }
        .cell-input:focus { background: rgba(74, 144, 226, 0.1); }
        textarea.cell-input { min-height: 80px; white-space: pre-wrap; }

        /* ë²„íŠ¼ ë° ê¸°íƒ€ */
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        button.action-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin-top: 10px; }
        
        .loading { text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('next-meal')">ë‹¤ìŒ ì‹ì‚¬</button>
    <button class="tab-btn" onclick="switchTab('weekly')">ì£¼ê°„ ë©”ë‰´</button>
    <button class="tab-btn" onclick="switchTab('upload')">ë©”ë‰´ ì—…ë¡œë“œ</button>
</div>

<div id="next-meal" class="content active">
    <div id="next-meal-container">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<div id="weekly" class="content">
    <div style="overflow-x: auto;">
        <table class="menu-table" id="weekly-table">
            </table>
    </div>
</div>

<div id="upload" class="content">
    <div id="login-form">
        <h3>ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
        <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="padding:10px; width:80%; margin-bottom:10px;">
        <button class="action-btn" onclick="checkLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="upload-form" style="display:none;">
        <h3>ì£¼ê°„ ë©”ë‰´ ì…ë ¥</h3>
        <p style="font-size:0.9em; color:gray; margin-bottom:10px;">
            ê° ì¹¸ì— ë‚´ìš©ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì—‘ì…€ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br>
            (ì¤„ë°”ê¿ˆì´ í¬í•¨ëœ ë©”ë‰´ë„ ê·¸ëŒ€ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.)
        </p>

        <div style="overflow-x: auto;">
            <table class="input-grid" id="edit-table">
                <tr>
                    <th>ë‚ ì§œ</th>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                    <td><input class="cell-input" placeholder="00ì›”00ì¼"></td>
                </tr>
                <tr>
                    <th>ìš”ì¼</th>
                    <td><input class="cell-input" value="í† "></td>
                    <td><input class="cell-input" value="ì¼"></td>
                    <td><input class="cell-input" value="ì›”"></td>
                    <td><input class="cell-input" value="í™”"></td>
                    <td><input class="cell-input" value="ìˆ˜"></td>
                    <td><input class="cell-input" value="ëª©"></td>
                    <td><input class="cell-input" value="ê¸ˆ"></td>
                </tr>
                <tr>
                    <th>ì¡°ì‹</th>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                </tr>
                <tr>
                    <th>ì¤‘ì‹</th>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                </tr>
                <tr>
                    <th>ì„ì‹</th>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                    <td><textarea class="cell-input"></textarea></td>
                </tr>
            </table>
        </div>

        <button class="action-btn" onclick="uploadMenuFromGrid()">ì—…ë¡œë“œ í•˜ê¸°</button>
    </div>
</div>

<button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>

<script>
    // â–¼â–¼â–¼ ì—¬ê¸°ì— ë³¸ì¸ì˜ ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby...YOUR_URL.../exec'; 
    
    let globalMenuData = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        applyTheme();
    });

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchData() {
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                globalMenuData = data.menu;
                if(globalMenuData && globalMenuData.length > 0) {
                    renderNextMeal();
                    renderWeeklyTable();
                } else {
                    document.getElementById('next-meal-container').innerHTML = '<div class="card">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(err => {
                document.getElementById('next-meal-container').innerHTML = '<div class="card">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            });
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // [íƒ­ 1] ë‹¤ìŒ ì‹ì‚¬ (ë¡œì§ ë™ì¼)
    function renderNextMeal() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentDay = now.getDay(); 
        
        let dayIdx = currentDay === 6 ? 1 : currentDay + 2;
        if (dayIdx > 7) dayIdx = 2; 

        let currentMealType = -1; 
        if (currentHour < 5) currentMealType = 0; 
        else if (currentHour < 6) currentMealType = 1; 
        else if (currentHour < 12) currentMealType = 2; 
        else if (currentHour < 13) currentMealType = 3; 
        else if (currentHour < 18) currentMealType = 4; 
        else if (currentHour < 20) currentMealType = 5; 
        else currentMealType = 6; 

        const container = document.getElementById('next-meal-container');
        container.innerHTML = '';

        function getMealInfo(dIdx, typeRow) {
            const dateStr = globalMenuData[0][dIdx] + " (" + globalMenuData[1][dIdx] + ")";
            const typeStr = globalMenuData[typeRow][0];
            const menuStr = globalMenuData[typeRow][dIdx];
            return { date: dateStr, type: typeStr, menu: menuStr };
        }

        let mealsToShow = [];
        
        if (currentMealType <= 1) { 
            mealsToShow.push(getMealInfo(dayIdx, 2)); 
            mealsToShow.push(getMealInfo(dayIdx, 3)); 
        } else if (currentMealType <= 3) { 
            mealsToShow.push(getMealInfo(dayIdx, 3)); 
            mealsToShow.push(getMealInfo(dayIdx, 4)); 
        } else if (currentMealType <= 5) { 
            mealsToShow.push(getMealInfo(dayIdx, 4)); 
            let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) mealsToShow.push(getMealInfo(nextDayIdx, 2));
        } else { 
             let nextDayIdx = dayIdx + 1;
            if(nextDayIdx <= 7) {
                mealsToShow.push(getMealInfo(nextDayIdx, 2)); 
                mealsToShow.push(getMealInfo(nextDayIdx, 3)); 
            } else {
                 mealsToShow.push({date: "ë‹¤ìŒ ì£¼", type: "ì¡°ì‹", menu: "ì‹ë‹¨í‘œ ì—…ë°ì´íŠ¸ í•„ìš”"});
            }
        }

        mealsToShow.forEach((m, i) => {
            const label = i === 0 ? "ê³§ ë‹¤ê°€ì˜¤ëŠ” ì‹ì‚¬" : "ê·¸ ë‹¤ìŒ ì‹ì‚¬";
            container.innerHTML += `
                <div class="card">
                    <div class="meal-title">${label} - ${m.date} ${m.type}</div>
                    <div class="meal-menu">${m.menu || '-'}</div>
                </div>
            `;
        });
    }

    // [íƒ­ 2] ì£¼ê°„ ë©”ë‰´ í…Œì´ë¸”
    function renderWeeklyTable() {
        const table = document.getElementById('weekly-table');
        let html = '';
        globalMenuData.forEach((row, rIdx) => {
            html += '<tr>';
            row.forEach((cell, cIdx) => {
                const tag = (cIdx === 0 || rIdx === 0 || rIdx === 1) ? 'th' : 'td';
                html += `<${tag}>${cell}</${tag}>`;
            });
            html += '</tr>';
        });
        table.innerHTML = html;
    }

    // [íƒ­ 3] ê´€ë¦¬ì ë° ì—…ë¡œë“œ (ê·¸ë¦¬ë“œ ìˆ˜ì§‘ ë°©ì‹)
    function checkLogin() {
        const pw = document.getElementById('admin-pw').value;
        if(pw === 'fgip.admin') {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('upload-form').style.display = 'block';
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    function uploadMenuFromGrid() {
        // 5í–‰ 8ì—´ ë°ì´í„° ìˆ˜ì§‘
        const table = document.getElementById('edit-table');
        const rows = table.querySelectorAll('tr');
        let data = [];

        // í—¤ë” í…ìŠ¤íŠ¸ (ê³ ì •ê°’)
        const rowHeaders = ["(ê³µë€)", "(ê³µë€)", "ì¡°ì‹", "ì¤‘ì‹", "ì„ì‹"];

        rows.forEach((tr, rIdx) => {
            let rowData = [];
            
            // ì²« ì—´ (í—¤ë”) ì¶”ê°€
            rowData.push(rowHeaders[rIdx]);

            // ë‚˜ë¨¸ì§€ 7ê°œ ì—´(ì…ë ¥ê°’) ê°€ì ¸ì˜¤ê¸°
            const inputs = tr.querySelectorAll('.cell-input');
            inputs.forEach(input => {
                rowData.push(input.value); // ì¤„ë°”ê¿ˆ(\n)ë„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            });

            data.push(rowData);
        });

        if(!confirm('ì‘ì„±í•œ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        // ì „ì†¡
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data) // 2ì°¨ì› ë°°ì—´ ì „ì†¡
        })
        .then(res => res.json())
        .then(resData => {
            if(resData.result === 'success') {
                alert('ì—…ë¡œë“œ ì„±ê³µ! ì ìš©ë©ë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + resData.message);
            }
        })
        .catch(err => alert('í†µì‹  ì˜¤ë¥˜: ' + err));
    }

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function applyTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) document.body.setAttribute('data-theme', saved);
    }
</script>
</body>
</html>
